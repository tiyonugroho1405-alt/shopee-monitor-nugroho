<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shopee Monitor Nugroho Firebase</title>
<link rel="manifest" href="manifest.json">
<style>
body{font-family:Arial;background:#f4f6f8;padding:15px;}
.card{background:white;padding:12px;margin-bottom:10px;border-radius:10px;}
input,button{padding:10px;margin:5px 0;width:100%;border-radius:6px;}
button{border:none;cursor:pointer;font-weight:bold;}
.posted{background:green;color:white;}
.delete{background:#333;color:white;}
.stats{font-size:18px;font-weight:bold;}
</style>
</head>
<body>

<h2>Shopee Monitor Nugroho (Realtime Sync)</h2>

<div class="card">
<label>Tanggal</label>
<input type="date" id="tanggal">
<label>Jam</label>
<input type="time" id="jam">
<label>Produk</label>
<input type="text" id="produk">
<button onclick="tambah()">Tambah Jadwal</button>
</div>

<div class="card stats" id="stats"></div>
<div id="list"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";


const firebaseConfig = {
  apiKey: "AIzaSyBJr_T5_d8EwYGRY7eQGCOffUVGuf1tcVg",
  authDomain: "shopee-monitor-nugroho.firebaseapp.com",
  databaseURL: "https://shopee-monitor-nugroho-default-rtdb.firebaseio.com",
  projectId: "shopee-monitor-nugroho",
  storageBucket: "shopee-monitor-nugroho.firebasestorage.app",
  messagingSenderId: "870048461022",
  appId: "1:870048461022:web:79900a4e1f911f3824924f",
  measurementId: "G-W2DF2G8WLN"
};


const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let jadwal = {};
let TARGET = 15;
let notified = {};

document.getElementById("tanggal").value = new Date().toISOString().split('T')[0];

window.tambah = function() {
let tanggal = document.getElementById("tanggal").value;
let jam = document.getElementById("jam").value;
let produk = document.getElementById("produk").value;
push(ref(db,"jadwal"),{tanggal,jam,produk,status:"Pending"});
}

window.setPosted = function(key) {
update(ref(db,"jadwal/"+key),{status:"Posted"});
}

window.hapus = function(key) {
remove(ref(db,"jadwal/"+key));
}

onValue(ref(db,"jadwal"), snapshot=>{
jadwal = snapshot.val() || {};
render();
});

function render(){
let tanggal=document.getElementById("tanggal").value;
let entries=Object.entries(jadwal).filter(([k,v])=>v.tanggal===tanggal);
let posted=entries.filter(([k,v])=>v.status==="Posted").length;
let pending=entries.filter(([k,v])=>v.status==="Pending").length;
document.getElementById("stats").innerHTML=`Posted: ${posted} / ${TARGET}<br>Pending: ${pending}`;
let html="";
entries.filter(([k,v])=>v.status==="Pending").forEach(([key,v])=>{
html+=`<div class="card">
<b>${v.jam} - ${v.produk}</b><br>
<button class="posted" onclick="setPosted('${key}')">Posted</button>
<button class="delete" onclick="hapus('${key}')">Hapus</button>
</div>`;
});
document.getElementById("list").innerHTML=html;
checkAlarm();
}

function showNotification(text){
navigator.serviceWorker.getRegistration().then(reg=>{if(reg)reg.showNotification("Shopee Monitor",{body:text});});
let audio=new Audio("https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg");
audio.play();
}

function checkAlarm(){
let now=new Date();
let today=now.toISOString().split('T')[0];
let current=now.getHours().toString().padStart(2,'0')+":"+now.getMinutes().toString().padStart(2,'0');
Object.values(jadwal).forEach(item=>{
if(item.tanggal!==today) return;
if(item.status==="Posted") return;
let alarm=item.jam;
let [h,m]=alarm.split(":");
let before=new Date();before.setHours(h);before.setMinutes(m-5);
let beforeStr=before.getHours().toString().padStart(2,'0')+":"+before.getMinutes().toString().padStart(2,'0');
if(current===beforeStr&&!notified[alarm+"b"]){showNotification("5 menit lagi "+item.produk);notified[alarm+"b"]=true;}
if(current===alarm&&!notified[alarm]){showNotification("Waktunya posting "+item.produk);notified[alarm]=true;}
});
}

setInterval(checkAlarm,30000);

if("serviceWorker" in navigator)navigator.serviceWorker.register("sw.js");

</script>
</body>
</html>
